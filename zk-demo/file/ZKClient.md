ZooKeeper客户端
ZooKeeper客户端核心组件
ZooKeeper：客户端入口
ClientWatchManager：客户端Watcher管理器
HostProvider：客户端地址列表管理器
ClientCnxn：客户端核心线程，内部包含两个核心线程，SendThread，EventThread
SendThread：IO线程，主要负责客户端和服务端之间的网络通信
EventThread：事件线程，负责对服务端事件进行处理

ZooKeeper客户端启动过程
1-设置默认的Watcher
2-设置ZooKeeper服务器列表
3-启动ClientCnxn

客户端会话创建过程
1-初始化阶段
1.1-初始化ZooKeeper对象
1.2-设置默认的会话Watcher
1.3-构造地址列表管理器：HostProvider
1.4-创建并初始化网络连接器：ClientCnxn，同时初始化两个核心队列，outgoingQueue和pendingQueue，分别为客户端请求发送队列和服务端响应等待队列，这两个Queue的数据结构都是LinkedList<Packet>
1.5-初始化SendThread和EventThread，前者负责管理客户端和服务端的网络IO，后者负责进行客户端事件处理，并将ClientCnxnSocket对象分配给SendThread作为网络底层IO处理器，并初始化EventThread中的waitingEvents用于存放所有等待被客户端处理的事件
1.6-调用ClientCnxn的start方法，启动SendThread和EventThread
ZooKeeper.java


ClientCnxn.java


在ClinetCnxn中定义了两个队列，outgoingQueue和pendingQueue，分别表示待发送给服务端的请求数据包和从服务端获取的响应数据包，数据结构都是LinkedList<Packet>


2-会话创建阶段
1.7-SendThread线程从HostProvider服务器地址列表管理器中获取一个服务器地址，clientCnxnSocket和服务器建立TCP连接
1.8-使用从HostProvider中获取到的服务器地址，clientCnxnSocket和服务器建立TCP长连接
1.9-构造ConnectRequest对象
1.10-将ConnectRequest对象包装成Packet并加入到outgoingQueue，等待发送
1.11-发送ConnectRequest请求
SendThread.java

建立连接

连接

连接

将ConnectRequest对象包装成Packet对象并添加到outgoingQueue中


3-客户端响应处理阶段
1.12-ClientCnxnSocket接收到服务端的响应后，会首先判断当前的客户端是否已初始化，如果尚未完成初始化，那么认为该响应一定是会话创建请求的响应，交由readConnectResult方法处理
1.13-处理响应数据，反序列化成ConnectResponse，从ConnectResponse对象中获取sessionId
1.14-连接成功，通知SendThread线程，设置超时参数和sessionId等信息，更新客户端状态
1.15-生成SyncConnect-None事件，代表客户端和服务端会话创建成功，并将该事件传递给EventThread
1.16-查询Watcher管理器，找出对应的Watcher，并触发事件
1.17-客户端会话创建成功







EventThread的run方法触发事件